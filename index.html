
<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boarding-Pass Barcode Aztec QR Generator</title>
  
  <script src="js_qr_brd.js"></script>
  <style>
    body, input { font-family: monospace; }
    input, #classSel { font-size: 130%; }
    #textEdit { width: 100%; max-width: 500px; }
    #errMsg {
      position: fixed; top: 0; left: 0;
      color: red; font-size: 130%;
      background-color: #fee; text-align: center;
      width: 96%; padding: 4px;
      border: red solid 1px;
      visibility: hidden; max-width: 500px;
    }
    #theimg3 {
      width: 100%; max-width: 500px;
      margin: 20px 0;
    }
    #theimg2 { visibility: hidden; position: fixed; }
    .tlabel { display: inline-block; margin-top: 7px; }
    .unimpCol { color: #bbb; }
    #nameDisplay {
      font-size: 130%;
      font-family: monospace;
      margin-top: 10px;
    }
  </style>

  <script>
    "use strict"

    var textOut = null, textIn = "", fields = {}, run, ctx = null

    function start() {
      run = Module.cwrap('run', null, ['number', 'string', 'number', 'number'])
      ctx = theimg3.getContext('2d')
      dateEd.value = todayInputValue()

      formatName()
      ['bookRef', 'from', 'to', 'fOp', 'fNum'].forEach(f => formatField(f))
      readDate()
      formatClass()
      formatSeat()
      formatSeqNum()
      format()
    }

    function errclear() {
      errMsg.innerHTML = ''
      errMsg.style.visibility = 'hidden'
    }

    function err(msg) {
      if (errMsg.innerHTML == '') {
        errMsg.innerHTML = msg
        errMsg.style.visibility = 'visible'
      }
    }

    function update(fromRaw) {
      if (!fromRaw) textEdit.value = textIn
      else textIn = textEdit.value

      var ecc = parseInt(eccSelect.value)
      var ssize = parseInt(symSize.value)
      var btype = parseInt(codeTypeSel.value)
      run(btype, textIn, ecc, ssize)

      theimg2.onload = function () {
        theimg3.width = theimg2.width
        theimg3.height = theimg2.height
        ctx.drawImage(theimg2, 0, 0)
      }

      var b = new Blob([textOut], { type: "image/svg+xml" })
      var reader = new FileReader()
      reader.onload = e => theimg2.src = e.target.result
      reader.onerror = e => console.log(e)
      reader.readAsDataURL(b)
    }

    function format() {
      textIn = "M1" + fields.name + "E" + fields.bookRef + fields.from + fields.to
        + fields.fOp + fields.fNum + fields.date + fields.cls + fields.seat + fields.seqNum
        + "1" + "00"
      update()
    }

    function upPadRight(s, n) {
      s = s.toUpperCase()
      while (s.length < n) s += ' '
      return s.substr(0, n)
    }

    function padLeft(s, n) {
      s = s.toUpperCase()
      while (s.length < n) s = '0' + s
      return s.substr(0, n)
    }

    function formatName(doRun) {
      errclear()
      if (lastNameEd.value.length > 18) err("first name longer than 18 characters")

      var fullName = lastNameEd.value + "/" + firstNameEd.value
      if (fullName.length > 20) err("first+last name longer than 20 characters")

      fields.name = upPadRight(fullName, 20)

      // Update name display
      document.getElementById('nameDisplay').textContent = firstNameEd.value + " " + lastNameEd.value

      if (doRun) format()
    }

    const fldDef = {
      'bookRef': { pad: 7, desc: "Booking Ref" },
      'from': { pad: 3, desc: "From" },
      'to': { pad: 3, desc: "To" },
      'fOp': { pad: 3, desc: "Flight Operator" },
      'fNum': { pad: 5, desc: "Flight Number" }
    }

    function formatField(name, doRun) {
      errclear()
      var def = fldDef[name]
      var v = document.getElementById(name + "Ed").value
      if (v.length > def.pad) err(`"${def.desc}" longer than ${def.pad} chars`)
      fields[name] = upPadRight(v, def.pad)
      if (doRun) format()
    }

    function formatDay(doRun) {
      fields.date = padLeft(dayOfYearEd.value, 3)
      if (doRun) format()
    }

    function todayInputValue() {
      return new Date().toJSON().slice(0, 10)
    }

    function dayOfYear(yr, mon, mday) {
      var now = new Date(yr, mon, mday, 1, 0, 0)
      var start = new Date(yr, 0, 1, 0, 0)
      var diff = now - start
      return Math.floor(diff / (1000 * 60 * 60 * 24)) + 1
    }

    function readDate(toRun) {
      var [yr, mon, mday] = dateEd.value.split('-').map(Number)
      dayOfYearEd.value = dayOfYear(yr, mon - 1, mday)
      formatDay(toRun)
    }

    function formatClass(doRun) {
      fields.cls = classSel.value
      if (doRun) format()
    }

    function formatSeat(doRun) {
      errclear()
      var n = seatNumEd.value
      if (n.length > 4) err("Seat longer than 4 chars")
      fields.seat = padLeft(n, 4)
      if (doRun) format()
    }

    function formatSeqNum(doRun) {
      errclear()
      var n = seqNumEd.value
      if (n.length > 4) err("Seat longer than 4 chars")
      fields.seqNum = upPadRight(padLeft(n, 4), 5)
      if (doRun) format()
    }

    function typeUpdate() {
      symSize.value = codeTypeSel.value === "0" ? "11" : "6"
      update()
    }
  </script>
</head>

<body id="body" onload="start()">
  <div id="errMsg"></div>

  <div id="inputArea">
    <span class="tlabel">First Name</span><br>
    <input id="firstNameEd" type="text" value="John" oninput="formatName(true)"><br>

    <span class="tlabel">Last Name</span><br>
    <input id="lastNameEd" type="text" value="Doe" oninput="formatName(true)"><br>

    <span class="unimpCol tlabel">Booking-Ref</span><br>
    <input id="bookRefEd" class="unimpCol" type="text" value="XYZ123" oninput="formatField('bookRef', true)"><br>

    <span class="tlabel">From</span><br>
    <input id="fromEd" type="text" value="ZRH" oninput="formatField('from', true)"><br>

    <span class="tlabel">To</span><br>
    <input id="toEd" type="text" value="SFO" oninput="formatField('to', true)"><br>

    <span class="tlabel">Flight Operator</span><br>
    <input id="fOpEd" type="text" value="BA" oninput="formatField('fOp',true)"><br>

    <span class="tlabel">Flight Number</span><br>
    <input id="fNumEd" type="text" value="1234" oninput="formatField('fNum', true)"><br>

    <span class="tlabel">Date</span><br>
    <input id="dateEd" type="date" oninput="readDate(true)"><br>

    <span class="unimpCol tlabel">Day in year</span><br>
    <input id="dayOfYearEd" type="text" class="unimpCol" value="0" oninput="formatDay(true)"><br>

    <span class="tlabel">Class</span><br>
    <select id="classSel" onchange="formatClass(true)">
      <option value="F">First</option>
      <option value="C">Business</option>
      <option value="Y">Economy</option>
    </select><br>

    <span class="tlabel">Seat</span><br>
    <input id="seatNumEd" type="text" value="35A" oninput="formatSeat(true)"><br>

    <span class="unimpCol tlabel">Boarding Index</span><br>
    <input id="seqNumEd" class="unimpCol" type="text" value="0001" oninput="formatSeqNum(true)"><br>
  </div>

  <span class="unimpCol">Raw Data:</span><br>
  <textarea id="textEdit" rows="4" cols="50" class="unimpCol" oninput="update(true)">hello</textarea><br>

  <span class="unimpCol">Error-Correction</span>
  <select id="eccSelect" class="unimpCol" onchange="update()">
    <option value="0">-1</option>
    <option value="0">0</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
  </select><br>

  <span class="unimpCol">Symbol-Size</span>
  <input id="symSize" type="number" class="unimpCol" onchange="update()" value="11"><br>

  <select id="codeTypeSel" class="unimpCol" onchange="typeUpdate()">
    <option value="0">aztec</option>
    <option value="1">pdf417</option>
  </select><br><br>

  <img id="theimg2">
  <canvas id="theimg3"></canvas>

  <!-- ðŸ‘‡ Display name below the image -->
  <div id="nameDisplay"></div>
</body>
</html>
